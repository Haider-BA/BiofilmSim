function r2h=restricthto2h3Dper2(rh)

[Em,En,Ep]=size(rh);
% p=log2(size1(1)-1);
pm=(Em+1)/2;
pn=(En+1)/2;
pp=(Ep+1)/2;
r2h=rh(1:2:Em,1:2:En,1:2:Ep);
% rh=[rh,rh(:,2)];
Emm=Em-1;
Emmm=Em-2;
Emmmm=Em-3;
Enm=En-1;
Enmm=En-2;
Enmmm=En-3;
Epm=Ep-1;
Epmm=Ep-2;
Epmmm=Ep-3;
% Enp=En+1;



r2h(2:pm-1,2:pn-1,2:pp-1)=(rh(2:2:Emmmm,2:2:Enmmm,4:2:Epm)+rh(4:2:Emm,2:2:Enmmm,4:2:Epm)+...
    rh(2:2:Emmmm,4:2:Enm,4:2:Epm)+rh(4:2:Emm,4:2:Enm,4:2:Epm)+...
    rh(2:2:Emmmm,2:2:Enmmm,2:2:Epmmm)+rh(4:2:Emm,2:2:Enmmm,2:2:Epmmm)+...
    rh(2:2:Emmmm,4:2:Enm,2:2:Epmmm)+rh(4:2:Emm,4:2:Enm,2:2:Epmmm))/64+...
    (rh(2:2:Emmmm,2:2:Enmmm,3:2:Epmm)+rh(2:2:Emmmm,4:2:Enm,3:2:Epmm)+...
    rh(4:2:Emm,2:2:Enmmm,3:2:Epmm)+rh(4:2:Emm,4:2:Enm,3:2:Epmm)+rh(4:2:Emm,3:2:Enmm,4:2:Epm)+...
    rh(3:2:Emmm,4:2:Enm,4:2:Epm)+rh(2:2:Emmmm,3:2:Enmm,4:2:Epm)+rh(3:2:Emmm,2:2:Enmmm,4:2:Epm)+...
    rh(4:2:Emm,3:2:Enmm,2:2:Epmmm)+rh(3:2:Emmm,4:2:Enm,2:2:Epmmm)+...
    rh(2:2:Emmmm,3:2:Enmm,2:2:Epmmm)+rh(3:2:Emmm,2:2:Enmmm,2:2:Epmmm))/32+...
    (rh(4:2:Emm,3:2:Enmm,3:2:Epmm)+rh(2:2:Emmmm,3:2:Enmm,3:2:Epmm)+...
    rh(3:2:Emmm,2:2:Enmmm,3:2:Epmm)+rh(3:2:Emmm,4:2:Enm,3:2:Epmm)+rh(3:2:Emmm,3:2:Enmm,4:2:Epm)+...
    rh(3:2:Emmm,3:2:Enmm,2:2:Epmmm))/16+rh(3:2:Emmm,3:2:Enmm,3:2:Epmm)/8;

r2h(2:pm-1,2:pn-1,1)=(rh(2:2:Emmm,2:2:Enmmm,2)+rh(4:2:Emm,2:2:Enmmm,2)+...
    rh(2:2:Emmmm,4:2:Enm,2)+rh(4:2:Emm,4:2:Enm,2)+...
    rh(2:2:Emmmm,2:2:Enmmm,Epm)+rh(4:2:Emm,2:2:Enmmm,Epm)+...
    rh(2:2:Emmmm,4:2:Enm,Epm)+rh(4:2:Emm,4:2:Enm,Epm))/64+...
    (rh(2:2:Emmmm,2:2:Enmmm,1)+rh(4:2:Emm,4:2:Enm,1)+...
    rh(4:2:Emm,2:2:Enmmm,1)+rh(4:2:Emm,4:2:Enm,1)+rh(4:2:Emm,3:2:Enmm,2)+...
    rh(3:2:Emmm,4:2:Enm,2)+rh(2:2:Emmmm,3:2:Enmm,2)+rh(3:2:Emmm,2:2:Enmmm,2)+...
    rh(2:2:Emmmm,3:2:Enmm,Epm)+rh(3:2:Emmm,4:2:Enm,Epm)+...
    rh(2:2:Emmmm,3:2:Enmm,Epm)+rh(3:2:Emmm,2:2:Enmmm,Epm))/32+...
    (rh(4:2:Emm,3:2:Enmm,1)+rh(2:2:Emmmm,3:2:Enmm,1)+...
    rh(3:2:Emmm,2:2:Enmmm,1)+rh(3:2:Emmm,4:2:Enm,1)+rh(3:2:Emmm,3:2:Enmm,2)+...
    rh(3:2:Emmm,3:2:Enmm,Epm))/16+rh(3:2:Emmm,3:2:Enmm,1)/8; %periodic boundary
r2h(2:pm-1,2:pn-1,pp)=r2h(2:pm-1,2:pn-1,1);
    




r2h(1,2:pn-1,2:pp-1)=(rh(2,2:2:Enmmm,4:2:Epm)+rh(2,4:2:Enm,4:2:Epm)+...
    rh(2,2:2:Enmmm,2:2:Epmmm)+rh(2,4:2:Enm,2:2:Epmmm))/32+...
    (2*(rh(2,2:2:Enmmm,3:2:Epmm)+rh(2,4:2:Enm,3:2:Epmm)+rh(2,3:2:Enmm,4:2:Epm)+rh(2,3:2:Enmm,2:2:Epmmm))...
    +rh(1,4:2:Enm,4:2:Epm)+rh(1,2:2:Enmmm,4:2:Epm)+...
    +rh(1,4:2:Enm,2:2:Epmmm)+rh(1,2:2:Enmmm,2:2:Epmmm))/32+...
    (2*rh(2,3:2:Enmm,3:2:Epmm)+...
    rh(1,2:2:Enmmm,3:2:Epmm)+rh(1,4:2:Enm,3:2:Epmm)+rh(1,3:2:Enmm,4:2:Epm)+...
    rh(1,3:2:Enmm,2:2:Epmmm))/16+rh(1,3:2:Enmm,3:2:Epmm)/8;%bottom

r2h(pm,2:pn-1,2:pp-1)=(rh(Emm,2:2:Enmmm,4:2:Epm)+rh(Emm,4:2:Enm,4:2:Epm)+...
    rh(Emm,2:2:Enmmm,2:2:Epmmm)+rh(Emm,4:2:Enm,2:2:Epmmm))/32+...
    (2*(rh(Emm,2:2:Enmmm,3:2:Epmm)+rh(Emm,4:2:Enm,3:2:Epmm)+rh(Emm,3:2:Enmm,4:2:Epm)+rh(Emm,3:2:Enmm,2:2:Epmmm))...
    +rh(Em,4:2:Enm,4:2:Epm)+rh(Em,2:2:Enmmm,4:2:Epm)+...
    +rh(Em,4:2:Enm,2:2:Epmmm)+rh(Em,2:2:Enmmm,2:2:Epmmm))/32+...
    (2*rh(Emm,3:2:Enmm,3:2:Epmm)+...
    rh(Em,2:2:Enmmm,3:2:Epmm)+rh(Em,4:2:Enm,3:2:Epmm)+rh(Em,3:2:Enmm,4:2:Epm)+...
    rh(Em,3:2:Enmm,2:2:Epmmm))/16+rh(Em,3:2:Enmm,3:2:Epmm)/8;%top

r2h(2:pm-1,1,2:pp-1)=(rh(2:2:Emmmm,Enm,4:2:Epm)+rh(4:2:Emm,Enm,4:2:Epm)+...
    rh(2:2:Emmmm,2,4:2:Epm)+rh(4:2:Emm,2,4:2:Epm)+...
    rh(2:2:Emmmm,Enm,2:2:Epmmm)+rh(4:2:Emm,Enm,2:2:Epmmm)+...
    rh(2:2:Emmmm,2,2:2:Epmmm)+rh(4:2:Emm,2,2:2:Epmmm))/64+...
    (rh(2:2:Emmmm,Enm,3:2:Epmm)+rh(2:2:Emmmm,2,3:2:Epmm)+...
    rh(4:2:Emm,Enm,3:2:Epmm)+rh(4:2:Emm,2,3:2:Epmm)+rh(4:2:Emm,1,4:2:Epm)+...
    rh(3:2:Emmm,2,4:2:Epm)+rh(2:2:Emmmm,1,4:2:Epm)+rh(3:2:Emmm,Enm,4:2:Epm)+...
    rh(4:2:Emm,1,2:2:Epmmm)+rh(3:2:Emmm,2,2:2:Epmmm)+...
    rh(2:2:Emmmm,1,2:2:Epmmm)+rh(3:2:Emmm,Enm,2:2:Epmmm))/32+...
    (rh(4:2:Emm,1,3:2:Epmm)+rh(2:2:Emmmm,1,3:2:Epmm)+...
    rh(3:2:Emmm,Enm,3:2:Epmm)+rh(3:2:Emmm,2,3:2:Epmm)+rh(3:2:Emmm,1,4:2:Epm)+...
    rh(3:2:Emmm,1,2:2:Epmmm))/16+rh(3:2:Emmm,1,3:2:Epmm)/8;
r2h(2:pm-1,pn,2:pp-1)=r2h(2:pm-1,1,2:pp-1); %front/back periodic



r2h(1,2:pn-1,1)=(rh(2,2:2:Enmmm,2)+rh(2,4:2:Enm,2)+...
    rh(2,2:2:Enmmm,Epm)+rh(2,4:2:Enm,Epm))/32+...
    (2*(rh(2,2:2:Enmmm,1)+rh(2,4:2:Enm,1)+rh(2,3:2:Enmm,2)+rh(2,3:2:Enmm,Epm))...
    +rh(1,4:2:Enm,2)+rh(1,2:2:Enmmm,2)+...
    +rh(1,4:2:Enm,Epm)+rh(1,2:2:Enmmm,Epm))/32+...
    (2*rh(2,3:2:Enmm,1)+...
    rh(1,2:2:Enmmm,1)+rh(1,4:2:Enm,1)+rh(1,3:2:Enmm,2)+...
    rh(1,3:2:Enmm,Epm))/16+rh(1,3:2:Enmm,1)/8; %bottom periodic
r2h(1,2:pn-1,pp)=r2h(1,2:pn-1,1);

r2h(pm,2:pn-1,1)=(rh(Emm,2:2:Enmmm,2)+rh(Emm,4:2:Enm,2)+...
    rh(Emm,2:2:Enmmm,Epm)+rh(Emm,4:2:Enm,Epm))/32+...
    (2*(rh(Emm,2:2:Enmmm,1)+rh(Emm,4:2:Enm,1)+rh(Emm,3:2:Enmm,2)+rh(Emm,3:2:Enmm,Epm))...
    +rh(Em,4:2:Enm,2)+rh(Em,2:2:Enmmm,2)+...
    +rh(Em,4:2:Enm,Epm)+rh(Em,2:2:Enmmm,Epm))/32+...
    (2*rh(Emm,3:2:Enmm,1)+...
    rh(Em,2:2:Enmmm,1)+rh(Em,4:2:Enm,1)+rh(Em,3:2:Enmm,2)+...
    rh(Em,3:2:Enmm,Epm))/16+rh(Em,3:2:Enmm,1)/8;%top periodic
r2h(pm,2:pn-1,pp)=r2h(pm,2:pn-1,1);

r2h(2:pm-1,1,1)=(rh(2:2:Emmmm,Enm,2)+rh(4:2:Emm,Enm,2)+...
    rh(2:2:Emmmm,2,2)+rh(4:2:Emm,2,2)+...
    rh(2:2:Emmmm,Enm,Epm)+rh(4:2:Emm,Enm,Epm)+...
    rh(2:2:Emmmm,2,Epm)+rh(4:2:Emm,2,Epm))/64+...
    (rh(2:2:Emmmm,Enm,1)+rh(2:2:Emmmm,2,1)+...
    rh(4:2:Emm,Enm,1)+rh(4:2:Emm,2,1)+rh(4:2:Emm,1,2)+...
    rh(3:2:Emmm,2,2)+rh(2:2:Emmmm,1,2)+rh(3:2:Emmm,Enm,2)+...
    rh(4:2:Emm,1,Epm)+rh(3:2:Emmm,2,Epm)+...
    rh(2:2:Emmmm,1,Epm)+rh(3:2:Emmm,Enm,Epm))/32+...
    (rh(4:2:Emm,1,1)+rh(2:2:Emmmm,1,1)+...
    rh(3:2:Emmm,Enm,1)+rh(3:2:Emmm,2,1)+rh(3:2:Emmm,1,2)+...
    rh(3:2:Emmm,1,Epm))/16+rh(3:2:Emmm,1,1)/8;%right (or front) periodic
r2h(2:pm-1,1,pp)=r2h(2:pm-1,1,1);
r2h(2:pm-1,pn,1)=r2h(2:pm-1,1,1);
r2h(2:pm-1,pn,pp)=r2h(2:pm-1,pn,1);

r2h(1,1,2:pp-1)=(2*rh(2,Enm,4:2:Epm)+...
    2*rh(2,2,4:2:Epm)+...
    2*rh(2,Enm,2:2:Epmmm)+...
    2*rh(2,2,2:2:Epmmm))/64+...
    (2*rh(2,2,3:2:Epmm)+...
    rh(2,Enm,3:2:Epmm)+rh(2,2,3:2:Epmm)+...
    rh(1,2,4:2:Epm)+2*rh(2,1,4:2:Epm)+rh(1,Enm,4:2:Epm)+...
    2*rh(2,1,2:2:Epmmm)+rh(1,2,2:2:Epmmm)+...
    rh(1,Enm,2:2:Epmmm))/32+...
    (2*rh(2,1,3:2:Epmm)+...
    rh(1,Enm,3:2:Epmm)+rh(1,2,3:2:Epmm)+rh(1,1,4:2:Epm)+...
    rh(1,1,2:2:Epmmm))/16+rh(1,1,3:2:Epmm)/8;
r2h(1,pn,2:pp-1)=r2h(1,1,2:pp-1); %lower front/back periodic

r2h(pm,1,2:pp-1)=(2*rh(Emm,Enm,4:2:Epm)+...
    2*rh(Emm,2,4:2:Epm)+...
    2*rh(Emm,Enm,2:2:Epmmm)+...
    2*rh(Emm,2,2:2:Epmmm))/64+...
    (2*rh(Emm,2,3:2:Epmm)+...
    rh(Emm,Enm,3:2:Epmm)+rh(Emm,2,3:2:Epmm)+...
    rh(Em,2,4:2:Epm)+2*rh(Emm,1,4:2:Epm)+rh(Em,Enm,4:2:Epm)+...
    2*rh(Emm,1,2:2:Epmmm)+rh(Em,2,2:2:Epmmm)+...
    rh(Em,Enm,2:2:Epmmm))/32+...
    (2*rh(Emm,1,3:2:Epmm)+...
    rh(Em,Enm,3:2:Epmm)+rh(Em,2,3:2:Epmm)+rh(Em,1,4:2:Epm)+...
    rh(Em,1,2:2:Epmmm))/16+rh(Em,1,3:2:Epmm)/8;%upper front/back periodic
r2h(pm,pn,2:pp-1)=r2h(pm,1,2:pp-1);

r2h(1,1,1)=(2*rh(2,Enm,2)+...
    2*rh(2,2,2)+...
    2*rh(2,Enm,Epm)+...
    2*rh(2,2,Epm))/64+...
    (2*rh(2,2,1)+...
    rh(2,Enm,1)+rh(2,2,1)+...
    rh(1,2,2)+2*rh(2,1,2)+rh(1,Enm,2)+...
    2*rh(2,1,Epm)+rh(1,2,Epm)+...
    rh(1,Enm,Epm))/32+...
    (2*rh(2,1,1)+...
    rh(1,Enm,1)+rh(1,2,1)+rh(1,1,2)+...
    rh(1,1,Epm))/16+rh(1,1,1)/8;
r2h(1,pn,pp)=r2h(1,1,1); %lower right corner
r2h(1,pn,1)=r2h(1,1,1);
r2h(1,1,pp)=r2h(1,1,1);

r2h(pm,1,1)=(2*rh(Emm,Enm,2)+...
    2*rh(Emm,2,2)+...
    2*rh(Emm,Enm,Epm)+...
    2*rh(Emm,2,Epm))/64+...
    (2*rh(Emm,2,1)+...
    rh(Emm,Enm,1)+rh(Emm,2,1)+...
    rh(Em,2,2)+2*rh(Emm,1,2)+rh(Em,Enm,2)+...
    2*rh(Emm,1,Epm)+rh(Em,2,Epm)+...
    rh(Em,Enm,Epm))/32+...
    (2*rh(Emm,1,1)+...
    rh(Em,Enm,1)+rh(Em,2,1)+rh(Em,1,2)+...
    rh(Em,1,Epm))/16+rh(Em,1,1)/8;%upper right corner
r2h(pm,1,pp)=r2h(pm,1,1);
r2h(pm,pn,pp)=r2h(pm,1,1);
r2h(pm,pn,1)=r2h(pm,1,1);